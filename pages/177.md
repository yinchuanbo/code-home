---
date: 2024-05-20T21:05:53+08:00
title: "å†™ä¸€ä¸ªç®€ç‰ˆå‰ç«¯ç›‘æ§ SDK"
---

ä¸€ä¸ªå®Œæ•´çš„å‰ç«¯ç›‘æ§å¹³å°åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼šæ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥ã€æ•°æ®æ•´ç†å’Œå­˜å‚¨ã€æ•°æ®å±•ç¤ºï¼›æœ¬æ–‡åªå†™æ•°æ®é‡‡é›†ä¸ä¸ŠæŠ¥éƒ¨åˆ†ã€‚

![](../assets/images/articles/177/01.awebp)

![](../assets/images/articles/177/02.awebp)

## ä» 0 å¼€å§‹

åå­—å¾ˆé‡è¦ï¼Œä¸€ä¸ªå¥½çš„åå­—ä¼šè®©ä½¿ç”¨è€…å¾ˆå®¹æ˜“è®°ä½ï¼Œä¼šè®©ä½¿ç”¨è€…è«åäº§ç”Ÿä¸€ç§è‡ªè±ªæ„Ÿï¼Œä¼šæ›´å®¹æ˜“ä¼ æ’­ï¼›å¦‚æœåå­—èƒ½å¤Ÿåˆ‡åˆæŸç§å¤§é“ï¼Œæ›´èƒ½å¸¦æ¥é¡ºç†æˆç« çš„æ•ˆæœã€‚æœ¬æ–‡çš„ç›‘æ§ SDK å°±å«å››ç»´å§ï¼Œå¯“æ„ä¸Šå¸è§†è§’ã€‚å…¨å†™ `four-dimension`ï¼Œç®€å†™ä¸º FDã€‚

```js
class FourDimension {
  constructor() {
    this.init();
  }
  // åˆå§‹åŒ–
  init() {}
}
```

å®šä¹‰ä¸€ä¸ª FourDimension ç±»ï¼Œç›®å‰æœ‰æ„é€ å‡½æ•°ï¼Œæ„é€ å‡½æ•°æ— å‚æ•°ã€‚åªæœ‰ init æ–¹æ³•ï¼Œç”¨ä»¥åˆå§‹åŒ–ç±»ã€‚init æ–¹æ³•ç”¨ä»¥æ€§èƒ½ã€é”™è¯¯ã€è¡Œä¸ºæ•°æ®æ”¶é›†ã€‚

### ä¸ŠæŠ¥æ•°æ®æ–¹æ³•

ä¸šç•Œæ¯”è¾ƒæˆç†Ÿçš„æ–¹æ¡ˆï¼šä½¿ç”¨ 1x1 åƒç´ çš„ gif å›¾ç‰‡ä¸ŠæŠ¥ï¼Œæœ¬æ–‡ä¹Ÿæ˜¯ã€‚åŒæ—¶ä¹Ÿå¯ä»¥ä½¿`navigator.sendBeacon`ï¼Œ`navigator.sendBeacon` æ˜¯ä¸€ä¸ªç”¨äºå‘é€å°‘é‡æ•°æ®åˆ°æœåŠ¡å™¨çš„æµè§ˆå™¨ APIã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ä¸ªä¼˜ç‚¹

1. **å¼‚æ­¥å’Œéé˜»å¡**ï¼š`navigator.sendBeacon` æ˜¯å¼‚æ­¥çš„ï¼Œå®ƒä¸ä¼šé˜»å¡æµè§ˆå™¨çš„å…¶ä»–æ“ä½œã€‚è¿™å¯¹äºæ€§èƒ½ç›‘æ§æ¥è¯´éå¸¸é‡è¦ï¼Œå› ä¸ºéƒ½ä¸å¸Œæœ›ç›‘æ§çš„è¿‡ç¨‹å½±å“åˆ°é¡µé¢çš„æ€§èƒ½ã€‚
2. **åœ¨é¡µé¢å¸è½½æ—¶ä»ç„¶å¯ä»¥å‘é€æ•°æ®**ï¼šå½“ç”¨æˆ·ç¦»å¼€é¡µé¢ï¼ˆä¾‹å¦‚å…³é—­é¡µé¢æˆ–è€…å¯¼èˆªåˆ°å…¶ä»–é¡µé¢ï¼‰æ—¶ï¼Œ`navigator.sendBeacon` ä»ç„¶å¯ä»¥å‘é€æ•°æ®ã€‚è¿™å¯¹äºæ•è·å’Œä¸ŠæŠ¥é¡µé¢å¸è½½å‰çš„æœ€åä¸€äº›æ€§èƒ½æ•°æ®æ¥è¯´éå¸¸æœ‰ç”¨ã€‚
3. **ä½ä¼˜å…ˆçº§**ï¼š`navigator.sendBeacon` å‘é€çš„è¯·æ±‚æ˜¯ä½ä¼˜å…ˆçº§çš„ï¼Œå®ƒä¸ä¼šå½±å“åˆ°é¡µé¢çš„å…¶ä»–ç½‘ç»œè¯·æ±‚ã€‚
4. **ç®€å•æ˜“ç”¨**ï¼š`navigator.sendBeacon` çš„ API éå¸¸ç®€å•ï¼Œåªéœ€è¦æä¾›ä¸ŠæŠ¥çš„ URL å’Œæ•°æ®ï¼Œå°±å¯ä»¥å‘é€è¯·æ±‚ã€‚

ä¸æ­¤åŒæ—¶ï¼Œ`navigator.sendBeacon` ä¹Ÿæœ‰ä¸€äº›é™åˆ¶ã€‚ä¾‹å¦‚ï¼Œå®ƒåªèƒ½å‘é€ POST è¯·æ±‚ï¼Œä¸èƒ½å‘é€ GET è¯·æ±‚ã€‚è€Œä¸”ï¼Œå®ƒå‘é€çš„è¯·æ±‚æ²¡æœ‰è¿”å›å€¼ï¼Œä¸èƒ½æ¥æ”¶æœåŠ¡å™¨çš„å“åº”ã€‚

æœ€åï¼Œä¸€äº›æ—§çš„æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒ `navigator.sendBeacon`ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨ `navigator.sendBeacon` æ—¶ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œå…¼å®¹æ€§å¤„ç†ã€‚

æœ¬æ–‡çš„æ–¹æ¡ˆæ˜¯ï¼Œä¼˜å…ˆ`navigator.sendBeacon`ï¼Œé™çº§ä½¿ç”¨ 1x1 åƒç´  gif å›¾ç‰‡ï¼Œæ ¹æ®å®é™…æƒ…å†µéœ€è¦é‡‡ç”¨ xhrã€‚

åˆ›å»º report.js å¢åŠ ä¸Šä¼ æ–¹æ³•

```js
import { isSupportSendBeacon } from "./util";

// å¦‚æœæµè§ˆå™¨ä¸æ”¯æŒ sendBeaconï¼Œå°±ä½¿ç”¨å›¾ç‰‡æ‰“ç‚¹
const sendBeacon = (function () {
  if (isSupportSendBeacon()) {
    return window.navigator.sendBeacon.bind(window.navigator);
  }
  const reportImageBeacon = function (url, data) {
    reportImage(url, data);
  };
  return reportImageBeacon;
})();

export function reportImage(url, data) {
  const img = new Image();
  img.src = url + "?reportData=" + encodeURIComponent(JSON.stringify(data));
}
```

## ä¸ŠæŠ¥æ—¶æœº

å‚è€ƒå…¶å®ƒæ–‡ç« ï¼Œä¸ŠæŠ¥æ—¶æœºé€‰æ‹©å¯¹å½“å‰é¡µé¢å½±å“æœ€å°çš„æ–¹æ¡ˆ

1. ä¸ŠæŠ¥æ—¶æœºæœ‰ä¸‰ç§ï¼š
2. é‡‡ç”¨ `requestIdleCallback/setTimeout` å»¶æ—¶ä¸ŠæŠ¥ã€‚
3. åœ¨ beforeunload å›è°ƒå‡½æ•°é‡Œä¸ŠæŠ¥ã€‚
4. ç¼“å­˜ä¸ŠæŠ¥æ•°æ®ï¼Œè¾¾åˆ°ä¸€å®šæ•°é‡åå†ä¸ŠæŠ¥ã€‚

å°†ä¸‰ç§æ–¹å¼ç»“åˆä¸€èµ·ä¸ŠæŠ¥ï¼š

å…ˆç¼“å­˜ä¸ŠæŠ¥æ•°æ®ï¼Œç¼“å­˜åˆ°ä¸€å®šæ•°é‡åï¼Œåˆ©ç”¨ `requestIdleCallback/setTimeout` å»¶æ—¶ä¸ŠæŠ¥ã€‚ åœ¨é¡µé¢ç¦»å¼€æ—¶ç»Ÿä¸€å°†æœªä¸ŠæŠ¥çš„æ•°æ®è¿›è¡Œä¸ŠæŠ¥ã€‚

åˆ›å»ºç¼“å­˜æ–‡ä»¶ cache.js

```js
import { deepCopy } from "./util";

const cache = [];

export function getCache() {
  return deepCopy(cache);
}

export function addCache(data) {
  cache.push(data);
}

export function clearCache() {
  cache.length = 0;
}
```

å…¶ä¸­ deepCopy

```js
export function deepCopy(target) {
  if (typeof target === "object") {
    const result = Array.isArray(target) ? [] : {};
    for (const key in target) {
      if (typeof target[key] == "object") {
        result[key] = deepCopy(target[key]);
      } else {
        result[key] = target[key];
      }
    }
    return result;
  }
  return target;
}
```

ä¿®æ”¹ä¸Šä¼ æ–‡ä»¶ report.js

```js
import { addCache, getCache, clearCache } from "./cache";
import config from "../config";
import { isSupportSendBeacon, generateUniqueID } from "./util";

const sendBeacon = (function () {
  if (isSupportSendBeacon()) {
    return window.navigator.sendBeacon.bind(window.navigator);
  }
  const reportImageBeacon = function (url, data) {
    reportImage(url, data);
  };
  return reportImageBeacon;
})();

const sessionID = generateUniqueID();
export function report(data, isImmediate = false) {
  if (!config.reportUrl) {
    console.error("è¯·è®¾ç½®ä¸Šä¼  url åœ°å€");
  }

  const reportData = JSON.stringify({
    id: sessionID,
    appID: config.appID,
    userID: config.userID,
    data,
  });

  if (isImmediate) {
    sendBeacon(config.reportUrl, reportData);
    return;
  }

  if (window.requestIdleCallback) {
    window.requestIdleCallback(
      () => {
        sendBeacon(config.reportUrl, reportData);
      },
      { timeout: 3000 }
    );
  } else {
    setTimeout(() => {
      sendBeacon(config.reportUrl, reportData);
    });
  }
}

let timer = null;
export function lazyReportCache(data, timeout = 3000) {
  addCache(data);

  clearTimeout(timer);
  timer = setTimeout(() => {
    const data = getCache();
    if (data.length) {
      report(data);
      clearCache();
    }
  }, timeout);
}

export function reportWithXHR(data) {
  // 1. åˆ›å»º xhr å¯¹è±¡
  let xhr = new XMLHttpRequest();
  // 2. è°ƒç”¨ open å‡½æ•°
  xhr.open("POST", config.reportUrl);
  // 3. è°ƒç”¨ send å‡½æ•°
  xhr.send(JSON.stringify(data));
}

export function reportImage(url, data) {
  const img = new Image();
  img.src = url + "?reportData=" + encodeURIComponent(JSON.stringify(data));
}
```

å…¶ä¸­ config.js æ–‡ä»¶

```js
const config = {
  reportUrl: "http://localhost:8000/reportData",
  projectName: "fd-example",
};

export function setConfig(options) {
  for (const key in config) {
    if (options[key]) {
      config[key] = options[key];
    }
  }
}
export default config;
```

## æ€§èƒ½æ•°æ®æ”¶é›†ä¸ŠæŠ¥

æ ¹æ®æœ€åˆçš„è§„åˆ’ï¼Œæ€§èƒ½ç›‘æ§éœ€è¦æ”¶é›†çš„æ•°æ®æŒ‡æ ‡éœ€è¦æœ‰ FPã€FCPã€LCPã€DOMContentLoadedã€onloadã€èµ„æºåŠ è½½æ—¶é—´ã€æ¥å£è¯·æ±‚æ—¶é—´ã€‚

æ”¶é›† FPã€FCPã€LCPã€èµ„æºåŠ è½½æ—¶é—´å…·ä½“æ˜¯åˆ©ç”¨æµè§ˆå™¨ Performance APIã€‚å…³äº Performance API å¯ä»¥å‚è€ƒï¼š[Performance](https://developer.mozilla.org/zh-CN/docs/Web/API/Performance)

### æ”¶é›†ä¸ŠæŠ¥ FP

FPï¼ˆFirst Paintï¼‰é¦–æ¬¡ç»˜åˆ¶ï¼Œå³æµè§ˆå™¨å¼€å§‹ç»˜åˆ¶é¡µé¢çš„æ—¶é—´ç‚¹ã€‚è¿™åŒ…æ‹¬äº†ä»»ä½•ç”¨æˆ·è‡ªå®šä¹‰çš„ç»˜åˆ¶ï¼Œå®ƒæ˜¯æ¸²æŸ“ä»»ä½•æ–‡æœ¬ã€å›¾åƒã€SVG ç­‰çš„å¼€å§‹æ—¶é—´

```js
import { getPageURL, isSupportPerformanceObserver } from "../utils/util";
import { lazyReportCache } from "../utils/report";

export default function observePaint() {
  if (!isSupportPerformanceObserver()) return;

  const entryHandler = (list) => {
    for (const entry of list.getEntries()) {
      if (entry.name === "first-paint") {
        observer.disconnect();
      }

      const json = entry.toJSON();
      delete json.duration;

      const reportData = {
        ...json,
        subType: entry.name,
        type: "performance",
        pageURL: getPageURL(),
      };

      lazyReportCache(reportData);
    }
  };

  const observer = new PerformanceObserver(entryHandler);
  // buffered å±æ€§è¡¨ç¤ºæ˜¯å¦è§‚å¯Ÿç¼“å­˜æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´è§‚å¯Ÿä»£ç æ·»åŠ æ—¶æœºæ¯”äº‹æƒ…è§¦å‘æ—¶æœºæ™šä¹Ÿæ²¡å…³ç³»ã€‚
  observer.observe({ type: "paint", buffered: true });
}
```

ä»£ç ä¸­`observer.disconnect()`æ˜¯ PerformanceObserver å¯¹è±¡çš„ä¸€ä¸ªæ–¹æ³•ï¼Œç”¨äºåœæ­¢è§‚å¯Ÿæ€§èƒ½æŒ‡æ ‡å¹¶æ–­å¼€ä¸å›è°ƒå‡½æ•°çš„è¿æ¥ã€‚

äº‹å®ä¸Š

```js
observer.observe({ type: "paint", buffered: true });
```

åŒ…å«ä¸¤ç§æ€§èƒ½æŒ‡æ ‡ï¼šfirst-contentful-paint å’Œ first-paintã€‚

å½“è°ƒç”¨`observer.disconnect()`æ–¹æ³•æ—¶ï¼ŒPerformanceObserver å¯¹è±¡å°†åœæ­¢è§‚å¯Ÿæ€§èƒ½æŒ‡æ ‡ï¼Œå¹¶ä¸”ä¸å†æ¥æ”¶ä»»ä½•æ€§èƒ½æŒ‡æ ‡çš„æ›´æ–°ã€‚ä¸æ­¤åŒæ—¶ï¼Œä¸å›è°ƒå‡½æ•°çš„è¿æ¥ä¹Ÿä¼šè¢«æ–­å¼€ï¼Œå³ä½¿æœ‰æ–°çš„æ€§èƒ½æŒ‡æ ‡æ•°æ®äº§ç”Ÿï¼Œä¹Ÿä¸ä¼šå†è§¦å‘å›è°ƒå‡½æ•°ã€‚

è¿™ä¸ªæ–¹æ³•é€šå¸¸åœ¨ä¸å†éœ€è¦è§‚å¯Ÿæ€§èƒ½æŒ‡æ ‡æ—¶è°ƒç”¨ï¼Œä»¥é¿å…ä¸å¿…è¦çš„èµ„æºæ¶ˆè€—ã€‚

### æ”¶é›†ä¸ŠæŠ¥ FCP

FCPï¼ˆFirst Contentful Paintï¼‰ï¼šé¦–æ¬¡å†…å®¹ç»˜åˆ¶ï¼Œå³æµè§ˆå™¨é¦–æ¬¡ç»˜åˆ¶ DOM å†…å®¹çš„æ—¶é—´ç‚¹ï¼Œå¦‚æ–‡æœ¬ã€å›¾åƒã€SVG ç­‰ã€‚

çœ‹èµ·æ¥ FCP å’Œ FP ä¸€è‡´ï¼Œå…¶å®è¿˜æ˜¯æœ‰åŒºåˆ«çš„

- FCPï¼ˆFirst Contentful Paintï¼‰ï¼šFCP æ˜¯æŒ‡é¡µé¢ä¸Šé¦–æ¬¡æ¸²æŸ“ä»»ä½•æ–‡æœ¬ã€å›¾åƒã€éç©ºç™½çš„ canvas æˆ– SVG çš„æ—¶é—´ç‚¹ã€‚å®ƒè¡¨ç¤ºäº†ç”¨æˆ·é¦–æ¬¡çœ‹åˆ°é¡µé¢æœ‰å®é™…å†…å®¹çš„æ—¶é—´ï¼Œå³é¡µé¢å¼€å§‹å‘ˆç°æœ‰æ„ä¹‰çš„å†…å®¹çš„æ—¶é—´ç‚¹ã€‚
- FPï¼ˆFirst Paintï¼‰ï¼šFP æ˜¯æŒ‡é¡µé¢ä¸Šé¦–æ¬¡æ¸²æŸ“ä»»ä½•å†…å®¹çš„æ—¶é—´ç‚¹ï¼ŒåŒ…æ‹¬èƒŒæ™¯é¢œè‰²ã€å›¾ç‰‡ã€æ–‡æœ¬ç­‰ã€‚å®ƒè¡¨ç¤ºäº†é¡µé¢å¼€å§‹å‘ˆç°ä»»ä½•å¯è§†åŒ–å†…å®¹çš„æ—¶é—´ï¼Œä½†ä¸ä¸€å®šæ˜¯æœ‰æ„ä¹‰çš„å†…å®¹ã€‚

ç®€è€Œè¨€ä¹‹ï¼ŒFCP å…³æ³¨çš„æ˜¯é¡µé¢ä¸Šé¦–æ¬¡å‘ˆç°æœ‰æ„ä¹‰å†…å®¹çš„æ—¶é—´ç‚¹ï¼Œè€Œ FP å…³æ³¨çš„æ˜¯é¡µé¢ä¸Šé¦–æ¬¡å‘ˆç°ä»»ä½•å¯è§†åŒ–å†…å®¹çš„æ—¶é—´ç‚¹ã€‚FCP æ›´å…³æ³¨ç”¨æˆ·æ„ŸçŸ¥çš„é¡µé¢åŠ è½½æ—¶é—´ï¼Œå› ä¸ºå®ƒè¡¨ç¤ºç”¨æˆ·å¯ä»¥å¼€å§‹é˜…è¯»æˆ–ä¸é¡µé¢è¿›è¡Œäº¤äº’çš„æ—¶é—´ç‚¹ã€‚è€Œ FP åˆ™æ›´å…³æ³¨é¡µé¢å¼€å§‹æ¸²æŸ“çš„æ—¶é—´ç‚¹ï¼Œæ— è®ºå†…å®¹æ˜¯å¦æœ‰æ„ä¹‰

```js
import { getPageURL, isSupportPerformanceObserver } from "../utils/util";
import { lazyReportCache } from "../utils/report";

export default function observePaint() {
  if (!isSupportPerformanceObserver()) return;

  const entryHandler = (list) => {
    for (const entry of list.getEntries()) {
      if (entry.name === "first-contentful-paint") {
        observer.disconnect();
      }

      const json = entry.toJSON();
      delete json.duration;

      const reportData = {
        ...json,
        subType: entry.name,
        type: "performance",
        pageURL: getPageURL(),
      };

      lazyReportCache(reportData);
    }
  };

  const observer = new PerformanceObserver(entryHandler);
  // buffered å±æ€§è¡¨ç¤ºæ˜¯å¦è§‚å¯Ÿç¼“å­˜æ•°æ®ï¼Œä¹Ÿå°±æ˜¯è¯´è§‚å¯Ÿä»£ç æ·»åŠ æ—¶æœºæ¯”äº‹æƒ…è§¦å‘æ—¶æœºæ™šä¹Ÿæ²¡å…³ç³»ã€‚

  observer.observe({ type: "paint", buffered: true });
}
```

### æ”¶é›†ä¸ŠæŠ¥ LCP

LCPï¼ˆLargest Contentful Paintï¼‰ï¼šæœ€å¤§å†…å®¹ç»˜åˆ¶ï¼Œå³è§†å£ä¸­æœ€å¤§çš„å›¾åƒæˆ–æ–‡æœ¬å—çš„æ¸²æŸ“å®Œæˆçš„æ—¶é—´ç‚¹

```js
import { getPageURL, isSupportPerformanceObserver } from "../utils/util";
import { lazyReportCache } from "../utils/report";

export default function observeLCP() {
  if (!isSupportPerformanceObserver()) {
    return;
  }

  const entryHandler = (list) => {
    if (observer) {
      observer.disconnect();
    }

    for (const entry of list.getEntries()) {
      const json = entry.toJSON();
      delete json.duration;

      const reportData = {
        ...json,
        target: entry.element?.tagName,
        name: entry.entryType,
        subType: entry.entryType,
        type: "performance",
        pageURL: getPageURL(),
      };

      lazyReportCache(reportData);
    }
  };

  const observer = new PerformanceObserver(entryHandler);
  observer.observe({ type: "largest-contentful-paint", buffered: true });
}
```

### æ”¶é›†ä¸ŠæŠ¥ DOMContentLoaded

DOMContentLoadedï¼šå½“ HTML æ–‡æ¡£è¢«å®Œå…¨åŠ è½½å’Œè§£æå®Œæˆåï¼Œ`DOMContentLoaded`äº‹ä»¶è¢«è§¦å‘ï¼Œæ— éœ€ç­‰å¾…æ ·å¼è¡¨ã€å›¾åƒå’Œå­æ¡†æ¶çš„å®ŒæˆåŠ è½½

```js
import { lazyReportCache } from "../utils/report";

export default function observerLoad() {
  ["DOMContentLoaded"].forEach((type) => onEvent(type));
}

function onEvent(type) {
  function callback() {
    lazyReportCache({
      type: "performance",
      subType: type.toLocaleLowerCase(),
      startTime: performance.now(),
    });

    window.removeEventListener(type, callback, true);
  }

  window.addEventListener(type, callback, true);
}
```

### æ”¶é›†ä¸ŠæŠ¥ onload æ•°æ®

onloadï¼šå½“æ‰€æœ‰éœ€è¦ç«‹å³åŠ è½½çš„èµ„æºï¼ˆå¦‚å›¾ç‰‡å’Œæ ·å¼è¡¨ï¼‰å·²åŠ è½½å®Œæˆæ—¶çš„æ—¶é—´ç‚¹

```js
import { lazyReportCache } from "../utils/report";

export default function observerLoad() {
  ["load"].forEach((type) => onEvent(type));
}

function onEvent(type) {
  function callback() {
    lazyReportCache({
      type: "performance",
      subType: type.toLocaleLowerCase(),
      startTime: performance.now(),
    });

    window.removeEventListener(type, callback, true);
  }

  window.addEventListener(type, callback, true);
}
```

### æ”¶é›†ä¸ŠæŠ¥èµ„æºåŠ è½½æ—¶é—´

æ”¶é›†èµ„æºåŠ è½½æ—¶é—´

```js
observer.observe({ type: "resource", buffered: true });
```

æˆ‘åœ¨æƒ³ä»€ä¹ˆæ˜¯èµ„æºåŠ è½½æ—¶é—´ï¼Ÿåº”è¯¥å°±æ˜¯ä¸‹é¢çš„`entry.duration`çš„ã€‚æˆ‘è§‰å¾—å†™ç›‘æ§ SDK å¾ˆæœ‰æ„ä¹‰ï¼Œå¯ä»¥æ›´åŠ æ·±å…¥çš„å­¦ä¹ æµè§ˆå™¨æ¨¡å‹ã€‚äº†è§£æµè§ˆå™¨æ˜¯æ€ä¹ˆçœ‹å¾…å„ç§ html æ–‡ä»¶èµ„æºçš„

```js
import { executeAfterLoad, isSupportPerformanceObserver } from "../utils/util";
import { lazyReportCache } from "../utils/report";

export default function observeEntries() {
  executeAfterLoad(() => {
    observeEvent("resource");
  });
}

export function observeEvent(entryType) {
  function entryHandler(list) {
    const data = list.getEntries();
    for (const entry of data) {
      if (observer) {
        observer.disconnect();
      }

      lazyReportCache({
        name: entry.name, // èµ„æºåç§°
        subType: entryType,
        type: "performance",
        sourceType: entry.initiatorType, // èµ„æºç±»å‹
        duration: entry.duration, // èµ„æºåŠ è½½è€—æ—¶
        dns: entry.domainLookupEnd - entry.domainLookupStart, // DNS è€—æ—¶
        tcp: entry.connectEnd - entry.connectStart, // å»ºç«‹ tcp è¿æ¥è€—æ—¶
        redirect: entry.redirectEnd - entry.redirectStart, // é‡å®šå‘è€—æ—¶
        ttfb: entry.responseStart, // é¦–å­—èŠ‚æ—¶é—´
        protocol: entry.nextHopProtocol, // è¯·æ±‚åè®®
        responseBodySize: entry.encodedBodySize, // å“åº”å†…å®¹å¤§å°
        responseHeaderSize: entry.transferSize - entry.encodedBodySize, // å“åº”å¤´éƒ¨å¤§å°
        resourceSize: entry.decodedBodySize, // èµ„æºè§£å‹åçš„å¤§å°
        startTime: performance.now(),
      });
    }
  }

  let observer;
  if (isSupportPerformanceObserver()) {
    observer = new PerformanceObserver(entryHandler);
    observer.observe({ type: entryType, buffered: true });
  }
}
```

### æ”¶é›†ä¸ŠæŠ¥æ¥å£è¯·æ±‚æ—¶é—´

è¿™é‡Œé€šè¿‡è¦†å†™åŸç”Ÿ xhr å¯¹è±¡æ–¹æ³•ï¼Œå¯¹æ–¹æ³•åšæ‹¦æˆªå®ç°æ¥å£æ—¶é—´æ”¶é›†ä»¥åŠä¸ŠæŠ¥

```js
import { originalOpen, originalSend, originalProto } from "../utils/xhr";
import { lazyReportCache } from "../utils/report";

function overwriteOpenAndSend() {
  originalProto.open = function newOpen(...args) {
    this.url = args[1];
    this.method = args[0];
    originalOpen.apply(this, args);
  };

  originalProto.send = function newSend(...args) {
    this.startTime = Date.now();

    const onLoadend = () => {
      this.endTime = Date.now();
      this.duration = this.endTime - this.startTime;

      const { status, duration, startTime, endTime, url, method } = this;
      const reportData = {
        status,
        duration,
        startTime,
        endTime,
        url,
        method: (method || "GET").toUpperCase(),
        success: status >= 200 && status < 300,
        subType: "xhr",
        type: "performance",
      };

      lazyReportCache(reportData);

      this.removeEventListener("loadend", onLoadend, true);
    };

    this.addEventListener("loadend", onLoadend, true);
    originalSend.apply(this, args);
  };
}

export default function xhr() {
  overwriteOpenAndSend();
}
```

## é”™è¯¯æ•°æ®æ”¶é›†ä¸ŠæŠ¥

æ ¹æ®æœ€åˆçš„è§„åˆ’éœ€è¦æ”¶é›†èµ„æºåŠ è½½é”™è¯¯ã€js é”™è¯¯å’Œ promise é”™è¯¯ã€‚

### æ”¶é›†ä¸ŠæŠ¥èµ„æºåŠ è½½é”™è¯¯

æ”¶é›† JavaScriptã€CSS å’Œå›¾ç‰‡çš„åŠ è½½é”™è¯¯ï¼Œä½¿ç”¨`window.addEventListener`ç›‘å¬é”™è¯¯

```js
import { lazyReportCache } from "../utils/report";
import { getPageURL } from "../utils/util";

export default function error() {
  // æ•è·èµ„æºåŠ è½½å¤±è´¥é”™è¯¯ js css img...
  window.addEventListener(
    "error",
    (e) => {
      const target = e.target;
      if (!target) return;

      if (target.src || target.href) {
        const url = target.src || target.href;
        lazyReportCache({
          url,
          type: "error",
          subType: "resource",
          startTime: e.timeStamp,
          html: target.outerHTML,
          resourceType: target.tagName,
          paths: e.path.map((item) => item.tagName).filter(Boolean),
          pageURL: getPageURL(),
        });
      }
    },
    true
  );
}
```

### æ”¶é›†ä¸ŠæŠ¥ js é”™è¯¯

æ”¶é›† JavaScript é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨ `window.onerror` æˆ–è€… `window.addEventListener('error', callback)`

```js
import { lazyReportCache } from "../utils/report";
import { getPageURL } from "../utils/util";

export default function error() {
  // ç›‘å¬ js é”™è¯¯
  window.onerror = (msg, url, line, column, error) => {
    lazyReportCache({
      msg,
      line,
      column,
      error: error.stack,
      subType: "js",
      pageURL: url,
      type: "error",
      startTime: performance.now(),
    });
  };
}
```

è¯´æ˜ä¸€ä¸‹`window.onerror`æ— æ³•æ•è·èµ„æºåŠ è½½é”™è¯¯ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥å•ç‹¬æ‹¿æ¥ç›‘å¬ js é”™è¯¯ã€‚

### æ”¶é›†ä¸ŠæŠ¥ promise é”™è¯¯

æ”¶é›† Promise é”™è¯¯ï¼Œå¯ä»¥ä½¿ç”¨ `window.addEventListener('unhandledrejection', callback)`

```js
import { lazyReportCache } from "../utils/report";
import { getPageURL } from "../utils/util";

export default function error() {
  // ç›‘å¬ promise é”™è¯¯ ç¼ºç‚¹æ˜¯è·å–ä¸åˆ°åˆ—æ•°æ®
  window.addEventListener("unhandledrejection", (e) => {
    lazyReportCache({
      reason: e.reason?.stack,
      subType: "promise",
      type: "error",
      startTime: e.timeStamp,
      pageURL: getPageURL(),
    });
  });
}
```

ä¸ºäº†å‡å°‘å¯¹ html æ–‡ä»¶ä»£ç çš„å¹²æ‰°ï¼Œé”™è¯¯æ”¶é›†å¯ä»¥æ·»åŠ ä¸€ä¸ªç¼“å­˜ä»£ç†ï¼Œå…·ä½“å‚è€ƒ[å­—èŠ‚å‰ç«¯ç›‘æ§å®è·µ](https://juejin.cn/post/7195496297150709821#heading-17)ã€‚

## è¡Œä¸ºæ•°æ®æ”¶é›†ä¸ŠæŠ¥

æ ¹æ®æœ€åˆçš„è§„åˆ’ï¼Œè¡Œä¸ºæ•°æ®æ”¶é›† pvã€uvï¼Œé¡µé¢åœç•™æ—¶é•¿ï¼Œç”¨æˆ·ç‚¹å‡»ã€‚

### æ”¶é›†ä¸ŠæŠ¥ pvã€uv

æ”¶é›† pvï¼ˆPage Viewï¼Œé¡µé¢æµè§ˆé‡ï¼‰å’Œ uvï¼ˆUnique Visitorï¼Œç‹¬ç«‹è®¿å®¢ï¼‰æ•°æ®ï¼Œéœ€è¦åœ¨æ¯æ¬¡é¡µé¢åŠ è½½æ—¶å‘é€ä¸€ä¸ªè¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œç„¶ååœ¨æœåŠ¡å™¨ç«¯è¿›è¡Œç»Ÿè®¡

```js
import { lazyReportCache } from "../utils/report";
import getUUID from "./getUUID";
import { getPageURL } from "../utils/util";

export default function pv() {
  lazyReportCache({
    type: "behavior",
    subType: "pv",
    startTime: performance.now(),
    pageURL: getPageURL(),
    referrer: document.referrer,
    uuid: getUUID(),
  });
}
```

è¿™é‡Œåªèƒ½æ”¶é›†äº† pv æ•°æ®ï¼Œuv æ•°æ®ç»Ÿè®¡éœ€è¦åœ¨æœåŠ¡ç«¯è¿›è¡Œã€‚

### é¡µé¢ä¸ŠæŠ¥åœç•™æ—¶é•¿

æ”¶é›†é¡µé¢åœç•™æ—¶é•¿ï¼Œå¯ä»¥åœ¨é¡µé¢åŠ è½½æ—¶è®°å½•ä¸€ä¸ªå¼€å§‹æ—¶é—´ï¼Œç„¶ååœ¨é¡µé¢å¸è½½æ—¶è®°å½•ä¸€ä¸ªç»“æŸæ—¶é—´ï¼Œä¸¤è€…çš„å·®å°±æ˜¯é¡µé¢çš„åœç•™æ—¶é•¿ã€‚è¿™ä¸ªè®¡ç®—é€»è¾‘å¯ä»¥æ”¾åœ¨ Â `beforeunload`Â  äº‹ä»¶é‡Œåš

```js
import { report } from "../utils/report";
import { onBeforeunload, getPageURL } from "../utils/util";
import getUUID from "./getUUID";

export default function pageAccessDuration() {
  onBeforeunload(() => {
    report(
      {
        type: "behavior",
        subType: "page-access-duration",
        startTime: performance.now(),
        pageURL: getPageURL(),
        uuid: getUUID(),
      },
      true
    );
  });
}
```

### ç”¨æˆ·ç‚¹å‡»ä¸ŠæŠ¥

æ”¶é›†ç”¨æˆ·ç‚¹å‡»äº‹ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ `addEventListener` æ¥ç›‘å¬ `click` äº‹ä»¶ï¼Œè¿™é‡Œå€ŸåŠ©äº†å†’æ³¡

```js
import { lazyReportCache } from "../utils/report";
import { getPageURL } from "../utils/util";
import getUUID from "./getUUID";

export default function onClick() {
  ["mousedown", "touchstart"].forEach((eventType) => {
    let timer;
    window.addEventListener(eventType, (event) => {
      clearTimeout(timer);
      timer = setTimeout(() => {
        const target = event.target;
        const { top, left } = target.getBoundingClientRect();

        lazyReportCache({
          top,
          left,
          eventType,
          pageHeight:
            document.documentElement.scrollHeight || document.body.scrollHeight,
          scrollTop:
            document.documentElement.scrollTop || document.body.scrollTop,
          type: "behavior",
          subType: "click",
          target: target.tagName,
          paths: event.path?.map((item) => item.tagName).filter(Boolean),
          startTime: event.timeStamp,
          pageURL: getPageURL(),
          outerHTML: target.outerHTML,
          innerHTML: target.innerHTML,
          width: target.offsetWidth,
          height: target.offsetHeight,
          viewport: {
            width: window.innerWidth,
            height: window.innerHeight,
          },
          uuid: getUUID(),
        });
      }, 500);
    });
  });
}
```

## æ”¹é€ å®Œå–„å››ç»´ç›‘æ§ç±»

å°†æ€§èƒ½æ•°æ®ã€é”™è¯¯æ•°æ®ã€è¡Œä¸ºæ•°æ®å…¥å£æ–‡ä»¶çš„æ”¶é›†æ–¹æ³•åœ¨ç›‘æ§ç±»å››ç»´`init`æ–¹æ³•å†…åˆå§‹åŒ–

```js
import performance from "./performance/index";
import behavior from "./behavior/index";
import error from "./error/index";

class FourDimension {
  constructor() {
    this.init();
  }
  // åˆå§‹åŒ–
  init() {
    performance();
    error();
    behavior();
  }
}

new FourDimension().init();
```

åœ¨å…·ä½“ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œé‡‡ç”¨å¼‚æ­¥åŠ è½½çš„æ–¹å¼å¼•å…¥ã€‚

### æ€»ç»“

å¦‚æœæ²¡æœ‰å…·ä½“æ•°æ®èƒ½å¤Ÿè¯æ˜è¿™ä¸ªç­–ç•¥æ˜¯ä¼˜çš„ï¼Œé‚£ä¹ˆå°±ä»ç†è®ºä¸Šé€‰ä¼˜çš„ã€‚è¿™ä¹Ÿæ˜¯æˆ‘å†™è¿™ç¯‡æ–‡ç« çš„ç†è®ºæ”¯æ’‘ä¹‹ä¸€ã€‚å› ä¸ºæ¯•ç«Ÿæ²¡æœ‰çœŸå®æ•°æ®åšéªŒè¯ã€‚

è¿˜æœ‰ä¸€ä¸ªæ”¯æ’‘æ˜¯å…ˆæ¨¡ä»¿ï¼Œç†è§£åˆ«äººçš„å†ç†å‡ºè‡ªå·±çš„æ€è·¯ï¼›è€Œä¸”å†™æ–‡ç« ä¹Ÿæ˜¯ç£ä¿ƒè‡ªå·±å­¦ä¹ çš„ä¸€ç§æ–¹å¼ã€‚æœ¬æ–‡å¤§é‡å‚è€ƒäº†[å‰ç«¯ç›‘æ§ SDK çš„ä¸€äº›æŠ€æœ¯è¦ç‚¹åŸç†åˆ†æ](https://juejin.cn/post/7017974567943536671) è¿™ç¯‡æ–‡ç« ã€‚å†™ç€å†™ç€å‘ç°å…³é”®æ˜¯æ•°æ®æ”¶é›†å’Œä¸ŠæŠ¥æ–¹å¼ï¼Œå…·ä½“ä¸ŠæŠ¥æ•°æ®æ¨¡å‹ä»¥åŠä¸ŠæŠ¥æ–¹å¼éœ€è¦åœ¨çœŸå®åœºæ™¯ä¸­ç ”ç©¶è¿­ä»£ã€‚ğŸ˜­

å½“ç„¶å¦ä¸€ä¸ªæ„ä¹‰ä¹Ÿè¯´äº†ï¼Œä»»ä½•äº‹æ²¡æœ‰åé¦ˆåˆ™æ²¡æœ‰è¿›æ­¥ã€‚ç›‘æ§å°±æ˜¯åé¦ˆã€‚

å¦å¤–ï¼Œæˆ‘æƒ³å¦‚æœè¿™ç§ç›‘æ§å¦‚æœå¯è§†åŒ–ï¼Œå°±å¦‚åŒå¯¹äººçš„ç›‘æ§ä¸€æ ·ï¼Œå°±ç®—æ˜¯æ²¡æœ‰è­¦æŠ¥äº‹ä»¶ï¼Œä¹Ÿèƒ½è®°å½•è¢«ç›‘æ§å¯¹è±¡çš„å„ç§è¡Œä¸ºæ•°æ®ã€‚ä¸€å®šä¼šå¾ˆæœ‰æœ‰æ„æ€ã€‚å³ä½¿æ²¡æœ‰é”™è¯¯ä¹Ÿèƒ½æœ‰ä¸€ç§å¯è§†åŒ–ç”»é¢ã€‚

ä»£ç åœ°å€ï¼š[github.com/zhensg123/râ€¦](https://github.com/zhensg123/rareRecord/tree/main/fourDemension)
